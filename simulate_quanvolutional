import torch
import torch.nn as nn
import torch.nn.functional as F
import torch.optim as optim
from torchvision import datasets, transforms
from torch.utils.data import DataLoader, random_split

import os
import numpy as np



import torchvision.transforms as transforms
from torchvision import datasets
from torch.utils.data import DataLoader

from PIL import Image

from qiskit import QuantumCircuit, Aer, execute
from qiskit.visualization import circuit_drawer, plot_histogram
from qiskit.quantum_info import Statevector

from Quanv2D import Quanv2D
from QuanvNN import QuanvNN

from darqk.core import Ansatz

import matplotlib.pyplot as plt

import random
import math
#random.seed(12345)
#np.random.seed(12345)

THRESHOLD = "THRESHOLD"
ROTATIONAL = "ROTATIONAL"

SAVE_PATH = ".\pre_processed_MNIST"


def get_data(n = 200, size = 10):
    # Define the transform to preprocess the MNIST images
    transform = transforms.Compose([
        transforms.Resize((size, size)),
        transforms.ToTensor(),  # Convert images to PyTorch tensors
    ])

    # Download the MNIST dataset and apply the transform
    mnist_train = datasets.MNIST(root='./data', train=True, transform=transform, download=True)

    # Set the number of training examples you want in the batch

    # Create a DataLoader with a batch size of n_train
    train_loader = DataLoader(mnist_train, batch_size=n, shuffle=True)

    # Iterate through the DataLoader to get the first batch
    for batch_idx, (data, labels) in enumerate(train_loader):
        # data is a tensor of shape (n_train, 1, 28, 28), labels is a tensor of shape (n_train,)
        print(f"Batch {batch_idx + 1}:")
        print(f"Data shape: {data.shape}")
        print(f"Labels shape: {labels.shape}")
        return data, labels  # Stop after the first batch

X, y = get_data(n=200)

model = QuanvNN(n_circuits=10, n_shots=10)
q_X = model.preprocess_dataset(X)

if not os.path.exists(SAVE_PATH):
    os.makedirs(SAVE_PATH)

np.save(SAVE_PATH + "\q_images.npy", q_X)
np.save(SAVE_PATH + "\q_labels.npy", y)

q_images = np.load(SAVE_PATH + "\q_images.npy")
q_labels = np.load(SAVE_PATH + "\q_labels.npy")

print("Printing new dataset shape:")
n_train, channels, w, h = q_images.shape
print(q_images.shape)

print("Printing old dataset shape:")
print(X.shape)


# Extract the first image (assuming n_train >= 1)
first_image = q_images[0]

# Plot each channel as a black and white image
for channel in range(channels):
    plt.subplot(1, channels, channel + 1)
    plt.imshow(first_image[channel], cmap='gray')
    plt.axis('off')  # Turn off axis labels and ticks
    plt.title(f'Channel {channel + 1}')

plt.show()

